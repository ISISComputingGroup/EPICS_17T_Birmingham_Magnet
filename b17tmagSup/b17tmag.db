# record(bo, "$(P)SIM")
# {
#     field(SCAN, "Passive")
#     field(DTYP, "Soft Channel")
#     field(ZNAM, "NO")
#     field(ONAM, "YES")
#     field(VAL, "$(RECSIM=0)")
#     field(PINI, "YES")
# }

record(bo, "$(P)DISABLE"){
    field(DESC, "Disable comms")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
    field(OMSL, "supervisory")
    field(ZNAM, "COMMS ENABLED")
    field(ONAM, "COMMS DISABLED")
}


record(ai, "$(P)FIELD"){
    field(DESC, "The field of the magnet at present")
    field(DTYP, "stream")
    field(PREC, "2")
    field(INP, "@b17tmag.proto getField($(P)) $(PORT)")
    field(SCAN, "1 second")
    field(EGU, "T")
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)CURR"){
    field(DESC, "The current of the magnet at present")
    field(DTYP, "stream")
    field(PREC, "2")
    field(INP, "@b17tmag.proto getField($(P)) $(PORT)")
    field(EGU, "A")
    # info(INTEREST, "HIGH")
}

record(mbbi, "$(P)HEATER"){
    field(DESC, "The status of the heater")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(INP, "@b17tmag.proto getHeater $(PORT)")
    field(ZRVL, "0")
    field(ZRST, "ON")
    field(ONVL, "1")
    field(ONST, "OFF")
    field(TWVL, "2")
    field(TWST, "OFF AT FIELD")
    field(THVL, "3")
    field(THST, "NO MATCH")
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)FIELD:PERSIST"){
    field(DESC, "Persistent field of magnet at present")
    field(DTYP, "Soft Channel") # To REMOVE
    # field(DTYP, "stream") # TO KEEP
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "T")
    # field(INP, "$(P)FIELD:SP CP MS") # TO REMOVE
    field(INP, "$(P)SEND_PERSIST_DIFF") # TEST
    # field(INP, "@b17tmag.proto getPersist($(P)) $(PORT)") # OLD
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)CURR:PERSIST"){
    field(DESC, "Persistent current of magnet at present")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "A")
    field(INP, "$(P)SEND_PERSIST_DIFF") # TEST
    # field(INP, "@b17tmag.proto getPersist($(P)) $(PORT)") # OLD
    # info(INTEREST, "HIGH")
}


# Waveform and fanout records for FIELD and CURR PERSIST PV's
# The waveform reads in getPersistMode values
record(waveform, "$(P)PERIST_READBACK_ARRAY"){
    field(DESC, "Persistent readback array values")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(INP,  "@b17tmag.proto getPersist($(P)) $(PORT)")
    field(NELM, "2")
    field(FTVL, "DOUBLE")
    field(FLNK, "$(P)SEND_PERSIST_DIFF")
}

# fanout record to pass on respective persist values to PV's
record(fanout, "$(P)SEND_PERSIST_DIFF"){
    field(DESC, "Send to respective PVs")
    field(SCAN, "Passive")
    field(LNK1, "$(P)FIELD:PERSIST")
    field(LNK2, "$(P)CURR:PERSIST")
}

record(bi, "$(P)MODE:PERSIST"){
    field(DESC, "Whether the magnets in persistent mode")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(INP, "@b17tmag.proto getPersistMode $(PORT)") # TO KEEP
    field(ZNAM, "ON")
    field(ONAM, "OFF")
    # info(INTEREST, "HIGH")
}

record(bo, "$(P)MODE:PERSIST:SP"){
    field(DESC, "The persistent field to set")
    field(DTYP, "stream")
    field(OUT, "@b17tmag.proto setPersistMode $(PORT)")
    field(ZNAM, "ON")
    field(ONAM, "OFF")
    field(VAL, "1")
    # info(INTEREST, "LOW")
}

record(bi, "$(P)READY"){
    field(DESC, "Whether the magnets stable and at field")
    field(DTYP, "stream") # TO KEEP
    field(SCAN, "1 second")
    field(INP, "@b17tmag.proto getReady $(PORT)")
    field(ZNAM, "ON")
    field(ONAM, "OFF")
    # info(INTEREST, "HIGH")
}

#  Need to run abort first (should be achievable in the protocol file)
record(ao, "$(P)FIELD:SP"){
    field(DESC, "The field to set")
    field(DTYP, "stream")
    field(PREC, "2")
    field(EGU, "T")
    field(OUT, "@b17tmag.proto setField $(PORT)")
    # field(FLNK, "$(P)FIELD:PERSIST") # TO REMOVE
    # info(INTEREST, "LOW")
}

record(ai, "$(P)TEMP:A"){
    field(DESC, "The temperature at sensor A")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "K")
    field(INP, "@b17tmag.proto getSensA $(PORT)")
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)TEMP:B"){
    field(DESC, "The temperature at sensor B")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "K")
    field(INP, "@b17tmag.proto getSensB $(PORT)")
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)TEMP:SET1"){
    field(DESC, "The temperature for setpoint 1")
    field(DTYP, "Soft Channel") # TO REMOVE
    # field(DTYP, "stream") # TO KEEP
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "K")
    # field(INP, "@b17tmag.proto getSet1 $(PORT)") # TO KEEP
    field(INP, "$(P)TEMP:SET1:SP") # TO REMOVE
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)TEMP:SET2"){
    field(DESC, "The temperature for setpoint 2")
    field(DTYP, "Soft Channel") # TO REMOVE
    # field(DTYP, "stream") # TO KEEP
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "K")
    # field(INP, "@b17tmag.proto getSet2 $(PORT)") # TO KEEP
    field(INP, "$(P)TEMP:SET2:SP") # TO REMOVE
    # info(INTEREST, "HIGH")
}

record(ao, "$(P)TEMP:SET1:SP"){
    field(DESC, "The temperature for setpoint 1")
    field(DTYP, "stream")
    field(EGU, "K")
    field(OUT, "@b17tmag.proto setSet1 $(PORT)")
    field(VAL, "0")
    field(FLNK, "$(P)TEMP:SET1") # TO REMOVE
    # info(INTEREST, "HIGH")
}

record(ao, "$(P)TEMP:SET2:SP"){
    field(DESC, "The temperature for setpoint 2")
    field(DTYP, "stream")
    field(EGU, "K")
    field(OUT, "@b17tmag.proto setSet2 $(PORT)")
    field(FLNK, "$(P)TEMP:SET2") # TO REMOVE
    field(VAL, "0")
    # info(INTEREST, "HIGH")
}

# # Alias's
alias("$(P)TEMP:SET1", "$(P)TEMP:HEATEX")
alias("$(P)TEMP:SET1:SP", "$(P)TEMP:HEATEX:SP")
alias("$(P)TEMP:SET2", "$(P)TEMP:PROBE")
alias("$(P)TEMP:SET2:SP", "$(P)TEMP:PROBE:SP")


record(ai, "$(P)NV:POS"){
    field(DESC, "The position of the needle valve")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(EGU, "mm")
    field(PREC, "2")
    field(INP, "@b17tmag.proto getNeedlePosition $(PORT)")
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)NV:POS:RBV"){
    field(DESC, "The current pressue target")
    field(DTYP, "Soft Channel") # TO REMOVE
    # field(DTYP, "stream") # TO KEEP
    field(SCAN, "1 second")
    field(EGU, "mm")
    field(PREC, "2")
    field(INP, "$(P)NV:POS:SP") # TO REMOVE
    # field(INP, "@b17tmag.proto getPressure($(P)) $(PORT)") # TO KEEP
    # field(INP, "@b17tmag.proto getPressure") Part of getPressure need to send in the prefix a well
    # info(INTEREST, "HIGH")
}

record(ai, "$(P)NV:PRESSURE"){
    field(DESC, "The current pressure")
    # field(DTYP, "Soft Channel") # To REMOVE
    field(DTYP, "stream") # TO KEEP
    field(EGU, "mbar")
    field(PREC, "2")
    # field(INP, "$(P)PRESSURE_DIFF_ARRAY.[0]") # TEST
    field(INP, "$(P)SEND_PRESSURE_DIFF") # TEST
    # field(INP, "NV:PRESSURE:SP CP MS") # To REMOVE
    # field(INP, "@b17tmag.proto getPressure($(P)) $(PORT)") #TO KEEP
    # field(INP, "@b17tmag.proto getPressure") Part of getPressure need to send in the prefix a well
    # info(INTEREST, "HIGH")
}

# # Not in manual but exists currently to satisfy manual proto file method
record(ai, "$(P)NV:PRESSURE:SP:RBV"){
    field(DESC, "The current pressue target")
    # field(DTYP, "Soft Channel") # To REMOVE
    field(DTYP, "stream") # TO KEEP
    field(SCAN, "1 second")
    field(EGU, "mbar")
    field(PREC, "2")
    # field(INP, "$(P)PRESSURE_DIFF_ARRAY.[1]") # TEST
    field(INP, "$(P)SEND_PRESSURE_DIFF") # TEST
    # field(INP, "$(P)NV:PRESSURE:SP CA MS") # TO REMOVE
    # field(INP, "@b17tmag.proto getPressure($(P)) $(PORT)") # TO KEEP
    # info(INTEREST, "HIGH")
}

#Alternative method of retreiving both NV:PRESSURE:SP:RBV and NV:PRESSURE
# Retrieve value and place in array. Then fanout INVIDISUAL RECORDS TO REPESCTIVE PV's
record(waveform, "$(P)PRESSURE_DIFF_ARRAY"){
    field(DESC, "Store expected and actual pressure")
    field(DTYP, "stream")
    field(INP,  "@b17tmag.proto getPressure($(P)) $(PORT)")
    field(NELM, "2")
    field(SCAN, "1 second")
    field(FTVL, "DOUBLE")
    field(FLNK, "$(P)SEND_PRESSURE_DIFF")
}

record(fanout, "$(P)SEND_PRESSURE_DIFF"){
    field(DESC, "Send respective pressure values to PV's")
    # field(SCAN, "Passive") #OLD
    field(SCAN, "1 second")
    field(LNK1, "$(P)NV:PRESSURE:SP:RBV")
    field(LNK2, "$(P)NV:PRESSURE")
}


record(ao, "$(P)NV:PRESSURE:SP"){
    field(DESC, "The pressue target")
    field(DTYP, "stream")
    field(EGU, "mbar")
    field(PREC, "2")
    field(VAL, "0")
    field(OUT, "@b17tmag.proto setPressure($(P)) $(PORT)")
    field(FLNK, "$(P)NV:PRESSURE:SP:RBV") # TO REMOVE
}

record(ao, "$(P)NV:POS:SP"){
    field(DESC, "The target position for the needle valve")
    field(DTYP, "stream")
    field(EGU, "mm")
    field(PREC, "2")
    field(OUT, "@b17tmag.proto setNeedlePosition ($(P)) $(PORT)")
    field(VAL, "0")
}

record(ai, "$(P)ATTO:POS"){
    field(DESC, "Angle of the attocube")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(EGU, "deg")
    field(PREC, "2")
    field(INP, "@b17tmag.proto getAttoAngle $(PORT)")
    # info(INTEREST, "HIGH")
}

# # Needs to be converted to a percentge of 243 
# # (divide the returned value by 243 then multiply by 100) 
# # - maybe possible at the proto file level
# # HE LEVEL Raw Input Value
record(ai, "$(P)HE:LEVEL_RAW"){
    field(DESC, "The current level of helium")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(PREC, "2")
    field(EGU, "%")
    field(INP, "@b17tmag.proto getHelLevel $(PORT)")
    field(FLNK, "$(P)HE:LEVEL:CALC PP")
    # info(INTEREST, "HIGH")
}

# # HE LEVEL Calc Value as Pecentage of 245
record(calcout, "$(P)HE:LEVEL:CALC"){
    field(DESC, "Percentage value of HE:LEVEL")
    field(INPA, "$(P)HE:LEVEL_RAW")
    field(CALC, "(A / 245) * 100")
    field(OUT, "$(P)HE:LEVEL PP")
}

# # HE LEVEL as percetnage of 245
record(ai, "$(P)HE:LEVEL"){
    field(DESC, "The current level of helium")
    # field(DTYP, "stream")
    field(PREC, "2")
    field(EGU, "%")
    # info(INTEREST, "HIGH")
}

record(ao, "$(P)ATTO:POS:SP"){
    field(DESC, "Angle for the AttoCube to go to")
    field(DTYP, "stream")
    field(EGU, "deg")
    field(PREC, "2")
    field(OUT, "@b17tmag.proto setAttoAngle $(PORT)")
    field(VAL, "0")
    # info(INTEREST, "LOW")
}

record(waveform, "$(P)MACRO:STAT") {
    field(DESC, "The current status of the system")
    field(NELM, "89")
    field(FTVL, "STRING")
    field(LOPR, "0")
    field(HOPR, "1024")
    field(SDIS, "$(P)MACRO:STAT:READ.RVAL")
    field(DISV, "1")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    field(INP, "@b17tmag.proto getMacroStatus $(PORT)") # Only read when MACRO:STAT:READ is True
    # info(INTEREST, "MEDIUM")
}

# May need to be treated as a busy or similar.
# but allows for the reading (or not) of the status macro
record(bo, "$(P)MACRO:STAT:READ"){
    field(DESC, "Whether or not to read MACRO:STAT $(PORT)")
    field(VAL, "0")
    field(ZNAM, "True")
    field(ONAM, "False")
    # info(INTEREST, "MEDIUM")
}



# Check if Macro STAT Read is true and process Macro stat, else, keep checking until Macro STAT Read is true 
# record(calcout, "$(P)MACRO:STAT:PP") {
#     field(DESC, "Process MACRO:STAT if READ True")
#     field(SCAN, "1 second")
#     field(INPA, "$(P)MACRO:STAT:READ.VAL")
#     field(CALC, "A=?$(P)MACRO:STAT:1")
# }



# # CALC record to disable MACRO:STAT is MACRO:STAT:READ is False else enable

# #  Maybe an intemediary record that can be disabled by MACRO:STAT 
# # or control BUSY field in MACRO:STAT waveform record


